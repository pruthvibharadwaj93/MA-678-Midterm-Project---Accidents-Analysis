---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}

path <- "/Users/pruthvibharadwaj/Desktop/MA678 - ASM/Midterm Project/Accidents new/CC-EST2020-ALLDATA6.csv"

pop <- read.csv(path)

cols <- c('STATE','COUNTY','STNAME','CTYNAME','TOT_POP','TOT_MALE','TOT_FEMALE')
pop <- pop[pop$YEAR == 14,cols]
pop$TOT_POP <- as.numeric(pop$TOT_POP)

pop_agg <- pop %>% group_by(STATE,COUNTY,STNAME,CTYNAME) %>% summarise(TOT_POP=sum(TOT_POP))

```

```{r}

patharea <- "/Users/pruthvibharadwaj/Desktop/MA678 - ASM/Midterm Project/Accidents new/us_areas.csv"

area <- read.csv(patharea)

pop_agg <- pop_agg[-c(1804),]
pop_agg$CTY <- substrRight(pop_agg$CTYNAME ,7)

pop_area <- inner_join(x=pop_agg, y=area, by=c("STNAME"="NAME_x","CTY"="NAME_y"))



```


```{r}

pathcountytransportation <- "/Users/pruthvibharadwaj/Desktop/MA678 - ASM/Midterm Project/Accidents new/County_Transportation_Profiles.csv"

cty_trsnprt <- read.csv(pathcountytransportation)

drop <- c("County.FIPS","State.FIPS","Total.Docks","Total.Marinas","Rout.miles.of.freight.railroad","Route.miles.ofpassenger.railroad.and.rail.transit","Route.miles.of.freight.railroad","Route.miles.of.passenger.railroad.and.rail.transit","Number.of.residents")

cty_trsnprt <- cty_trsnprt[,!(names(cty_trsnprt) %in% drop)]
cty_trsnprt$County.Name <- substrRight(cty_trsnprt$County.Name,7)

pop_area_trsnprt <- inner_join(x=pop_area, y=cty_trsnprt, by=c("STNAME"="State.Name","CTY"="County.Name"))

```

```{r}

```

#Creating new temporal variable columns from timestamp
```{r}

```

#Creating new binary variable for POI variables
```{r}
accidentsne$amenity_b <- ifelse(accidentsne$Amenity == "True",1,0)
accidentsne$bump_b <- ifelse(accidentsne$Bump == "True",1,0)
accidentsne$crossing_b <- ifelse(accidentsne$Crossing == "True",1,0)
accidentsne$give_way_b <- ifelse(accidentsne$Give_Way == "True",1,0)
accidentsne$junction_b <- ifelse(accidentsne$Junction == "True",1,0)
accidentsne$noexit_b <- ifelse(accidentsne$No_Exit == "True",1,0)
accidentsne$railway_b <- ifelse(accidentsne$Railway == "True",1,0)
accidentsne$roundabout_b <- ifelse(accidentsne$Roundabout == "True",1,0)
accidentsne$station_b <- ifelse(accidentsne$Station == "True",1,0)
accidentsne$stop_b <- ifelse(accidentsne$Stop == "True",1,0)
accidentsne$traffic_calming_b <- ifelse(accidentsne$Traffic_Calming == "True",1,0)
accidentsne$traffic_signal_b <- ifelse(accidentsne$Traffic_Signal == "True",1,0)
accidentsne$turning_loop_b <- ifelse(accidentsne$Turning_Loop == "True",1,0)
accidentsne$sunrise_sunset_b <- ifelse(accidentsne$Sunrise_Sunset == "Day",1,0)
```

#Dropping irrelevant columns and dropping 2016 and 2020 data as it is incomplete

```{r}
drop <- c("Start_Time","End_Time","Description","Number","Street","Zipcode","Timezone","Airport_Code","Weather_Timestamp","Distance.mi.","Start_Lat","Start_Lng","End_Lng","End_Lat","Country","City","Wind_Direction","Civil_Twilight","Nautical_Twilight","Astronomical_Twilight","Severity","Amenity","Bump","Crossing","Give_Way","Junction","No_Exit","Railway","Roundabout","Station","Stop","Traffic_Calming","Traffic_Signal","Turning_Loop","Sunrise_Sunset","Temperature.F.","Wind_Chill.F.","Humidity...","Pressure.in.","Visibility.mi.","Wind_Speed.mph.","Precipitation.in.")

accidentsne <- accidentsne %>% filter(year %in% c(2017,2018,2019))
accidentsne <- accidentsne[,!(names(accidentsne) %in% drop)]



```

#Data aggregation 
```{r}
accidents_ne_agg <- accidentsne %>% group_by(State, County) %>% summarise(n=n())
```
```{r}
plot(accidents_ne_agg$crossing, log(accidents_ne_agg$n))

```

```{r}
accidents_ne_agg <- accidentsne %>% group_by(State, County) %>% summarise(n=n())
```


```{r}
ggplot(accidents_ne_agg) + geom_line(aes(x=wday,y=n))
```
```{r}

final <- inner_join(x=accidents_ne_agg, y=pop_area_trsnprt, by=c("State"="STUSPS","County"="CTY"))

drop <- c("STATE","COUNTY","STNAME","CTYNAME","X","Primary.and.Commercial.Airports","Non.Commercial..Other.Aerodromes", "Non.Commercial..Civil.Public.Use.Airports.and.Seaplane.base","X..of.Medium.to.Fair.Condition.Bridges")

final <- final[,!(names(final) %in% drop)]

final$popdens <- final$TOT_POP/final$area

final$poor.bridges <- final$X..of.Poor.Condition.Bridges*final$Number.of.Bridges

final$poor.bridges <- final$X..of.Poor.Condition.Bridges*final$Number.of.Bridges

final$commuters <- (final$Number.of.workers.from.other.counties.who.commute.to.work.in.the.county + final$Number.of.resident.workers.who.commute.to.work.in.other.counties + final$Number.of.resident.workers.who.commute.within.county)

final$res_commuters <-  (final$Number.of.resident.workers.who.commute.to.work.in.other.counties + final$Number.of.resident.workers.who.commute.within.county)

final$non_res_commuters <- final$Number.of.workers.from.other.counties.who.commute.to.work.in.the.county

final$comm_dens <- final$commuters/final$area

final$business_dens <- final$Number.of.business.establishments/final$area 

final$transiters <- final$Percent.of.resident.workers.who.commute.by.transit * final$Number.of.resident.workers

final$transit_dens <- final$transiters/final$area

final$trans_comm <- final$transiters/final$commuters



```


```{r}
fit1<- lmer(data = final, log(n) ~   log(Number.of.Bridges)+ log(poor.bridges+1)  + log(comm_dens) +
             trans_comm + log(Number.of.business.establishments) + (1+log(comm_dens)|State) + (1+log(Number.of.business.establishments)|State) + (1+trans_comm|State) + (1+log(Number.of.Bridges)|State) + (1+log(poor.bridges+1)|State))

fit<- stan_lmer(data = final, log(n) ~   log(Number.of.Bridges)+ log(poor.bridges+1)  + log(comm_dens) +
             trans_comm + log(Number.of.business.establishments) + (1+log(comm_dens)|State))

plot_usmap(regions)

pp_check(fit1)

library(usmap)



plot_usmap(data = final_agg, values = "n", color = "red") + 
  scale_fill_continuous(name = "n", label = scales::comma) + 
  theme(legend.position = "right")

plot_usmap(data = final_agg, values = "n", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "n", label = scales::comma
  ) + theme(legend.position = "right")

install.packages("usmap")
library(lattice)

final_agg <- final %>% group_by(STATEFP) %>% summarise(n=sum(n))

final_agg <- rename(final_agg, fips = STATEFP)

final_agg_com <- final %>% group_by(STATEFP) %>% summarise(commuters=sum(commuters),area=sum(area))

final_agg_com$comm_dens <- final_agg_com$commuters/final_agg_com$area

final_agg_com <- final_agg_com[,c(1,4)]

final_agg_com <- rename(final_agg_com, fips = STATEFP)


plot_usmap(data = final_agg_com, values = "comm_dens", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "n", label = scales::comma
  ) + theme(legend.position = "right")




summary(fit1)
coef(fit)

qqmath(fit)

ggplot(data.frame(lev=hatvalues(fit),pearson=residuals(fit,type="pearson")),
      aes(x=lev,y=pearson)) +
    geom_point() +
    theme_bw()

plot(fit)


fixef(fit)

coef(fit)

final_map

coef(fit1)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

